/*
 * Copyright (c) 2024 Broadcom.  All Rights Reserved.  The term
 * "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.
 *
 * This software and all information contained therein is
 * confidential and proprietary and shall not be duplicated,
 * used, disclosed, or disseminated in any way except as
 * authorized by the applicable license agreement, without the
 * express written permission of Broadcom.  All authorized
 * reproductions must be marked with this language.
 *
 * EXCEPT AS SET FORTH IN THE APPLICABLE LICENSE AGREEMENT, TO
 * THE EXTENT PERMITTED BY APPLICABLE LAW, BROADCOM PROVIDES THIS
 * SOFTWARE WITHOUT WARRANTY OF ANY KIND, INCLUDING WITHOUT
 * LIMITATION, ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR
 * FITNESS FOR A PARTICULAR PURPOSE.  IN NO EVENT WILL BROADCOM
 * BE LIABLE TO THE END USER OR ANY THIRD PARTY FOR ANY LOSS OR
 * DAMAGE, DIRECT OR INDIRECT, FROM THE USE OF THIS SOFTWARE,
 * INCLUDING WITHOUT LIMITATION, LOST PROFITS, BUSINESS
 * INTERRUPTION, GOODWILL, OR LOST DATA, EVEN IF BROADCOM IS
 * EXPRESSLY ADVISED OF SUCH LOSS OR DAMAGE.
 */
package com.broadcom.restapi.sdk.config;

import com.broadcom.restapi.sdk.message.response.ApiMessage;

import lombok.RequiredArgsConstructor;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.http.server.PathContainer;
import org.springframework.stereotype.Component;
import org.springframework.web.util.pattern.PathPatternParser;

import org.springdoc.core.customizers.OpenApiCustomizer;

import io.swagger.v3.oas.models.Operation;
import io.swagger.v3.oas.models.responses.ApiResponses;
import io.swagger.v3.oas.models.media.Schema;
import io.swagger.v3.oas.models.responses.ApiResponse;
import io.swagger.v3.oas.models.media.Content;
import io.swagger.v3.oas.models.media.MediaType;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.PathItem;

import java.util.List;
import java.util.Map;

/**
 * Class that is used to configure the Open API (Swagger) infrastructure to include a description of the
 * 429 status code for each endpoint where call rate limiting is enforced and not bypassed.
 */
@Component
@RequiredArgsConstructor
@ConditionalOnProperty(name = "sdk.feature.web.requestRateLimiter", havingValue = "true")
public class CallRateSwaggerConfig implements OpenApiCustomizer {

    private static final String TOO_MANY_REQUESTS_MESSAGE = "Too many requests issued within the specified time period";

    private final CallRateParameters callRateParameters;

    /**
     * Method used to add the description for the 429 status code to the Open API (Swagger) documentation.
     *
     * @param operation The Open API <code>Operation</code> object used for documenting endpoints.
     * @param responseCode The HTTP response (status) code to document. For now, this will be 429.
     * @param description The description to use for the specified response code.
     */
    private void addApiMessageResponseToOperation(Operation operation, String responseCode, String description) {
        if (operation != null) {
            ApiResponses responses = operation.getResponses();
            if (responses == null) {
                responses = new ApiResponses();
                operation.setResponses(responses);
            }

            Schema<?> schema = new Schema<>().$ref(ApiMessage.class.getSimpleName());
            ApiResponse response = new ApiResponse().content(
                new Content().addMediaType(
                    org.springframework.http.MediaType.APPLICATION_JSON_VALUE,
                    new MediaType().schema(schema)))
                .description(description);

            responses.addApiResponse(responseCode, response);
        }
    }

    /**
     * Determine whether the input list of endpoints (paths) match the endpoint we are looking for.
     *
     * @param paths The list of endpoints to search through. Each entry may contain wildcards to allow for
     *              pattern matching.
     * @param searchPath The endpoint we are searching for in the list.
     * @return True if the search endpoint matches one of the list entries (after wildcard parse),
     * otherwise false.
     */
    private boolean containsPath(List<String> paths, String searchPath) {
        PathPatternParser parser = new PathPatternParser();
        var searchPathContainer = PathContainer.parsePath(searchPath);
        return paths.stream()
            .map(parser::parse)
            .anyMatch(p -> p.matches(searchPathContainer));
    }

    /**
     * Determines which API endpoints should have call rate limiting enabled and adds the appropriate
     * OpenAPI documentation to each of these endpoints.
     */
    @Override
    public void customise(OpenAPI openApi) {
        Map<String, PathItem> paths = openApi.getPaths();
        paths.forEach((path, pathItem) -> {
            boolean callRateFeatureEnforced = containsPath(callRateParameters.getCallRateEnforce(), path);
            boolean callRateFeatureBypassed = containsPath(callRateParameters.getCallRateBypass(), path);

            if (callRateFeatureEnforced && !callRateFeatureBypassed) {
                List<Operation> operations = pathItem.readOperations();
                for (Operation operation : operations) {
                    addApiMessageResponseToOperation(operation, "429", TOO_MANY_REQUESTS_MESSAGE);
                }
            }
        });
    }
}
